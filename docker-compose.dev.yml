services:
  dev:
    env_file:
      - path: .env
        required: false
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - '3000:3000'
    environment:
      # API + web run in the same container via Turborepo (see root `npm run dev`).
      VITE_BACKEND_ORIGIN: 'http://127.0.0.1:3001'
      CHOKIDAR_USEPOLLING: '1'

      # Backend runtime (safe defaults for local dev)
      VOLUME_ROOT: '/mnt'
      CONFIG_DIR: '/config'
      CACHE_DIR: '/cache'
      LOG_LEVEL: '${LOG_LEVEL:-debug}'
      PUBLIC_URL: '${PUBLIC_URL:-http://localhost:3000}'
      SESSION_SECRET: '${SESSION_SECRET:-dev-change-me}'

      # Optional integrations (set in `.env` or a local override compose file)
      OIDC_ENABLED: '${OIDC_ENABLED:-false}'
      OIDC_ISSUER: '${OIDC_ISSUER:-}'
      OIDC_CLIENT_ID: '${OIDC_CLIENT_ID:-}'
      OIDC_CLIENT_SECRET: '${OIDC_CLIENT_SECRET:-}'
      OIDC_SCOPES: '${OIDC_SCOPES:-openid,profile,email}'
      OIDC_ADMIN_GROUPS: '${OIDC_ADMIN_GROUPS:-}'

      COLLABORA_URL: '${COLLABORA_URL:-}'
      COLLABORA_DISCOVERY_URL: '${COLLABORA_DISCOVERY_URL:-}'
      COLLABORA_SECRET: '${COLLABORA_SECRET:-}'

      ONLYOFFICE_URL: '${ONLYOFFICE_URL:-}'
      ONLYOFFICE_SECRET: '${ONLYOFFICE_SECRET:-}'
      ONLYOFFICE_LANG: '${ONLYOFFICE_LANG:-en}'
      ONLYOFFICE_FILE_EXTENSIONS: '${ONLYOFFICE_FILE_EXTENSIONS:-}'

      USER_DIR_ENABLED: '${USER_DIR_ENABLED:-false}'
      USER_ROOT: '${USER_ROOT:-/srv/users}'

    volumes:
      # Hot reload the monorepo apps without masking `/app/node_modules` from the image.
      - ./apps:/app/apps
